# Langfuse Stable Configuration
# Secrets managed via Doppler + External Secrets Operator
# Updated: 2026-02-11 - Added system table TTLs via extraOverrides

langfuse:
  salt:
    secretKeyRef:
      name: langfuse-salt
      key: salt

  encryptionKey:
    secretKeyRef:
      name: langfuse-encryption
      key: encryption-key

  nextauth:
    url: "https://langfuse.el-jefe.me"
    secret:
      secretKeyRef:
        name: langfuse-nextauth
        key: nextauth-secret

  features:
    telemetryEnabled: false
    signUpDisabled: false

  # Web deployment configuration
  web:
    livenessProbe:
      initialDelaySeconds: 120
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

    readinessProbe:
      initialDelaySeconds: 60
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

  # Worker deployment configuration
  worker:
    livenessProbe:
      initialDelaySeconds: 60
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

# Use Neon PostgreSQL (external)
postgresql:
  deploy: false
  host: "ep-flat-resonance-addiekdb.c-2.us-east-1.aws.neon.tech"
  port: 5432
  auth:
    username: "neondb_owner"
    database: "langfuse"
    existingSecret: langfuse-postgresql
    secretKeys:
      userPasswordKey: postgres-password
  args: "sslmode=require"

# Use existing Redis
redis:
  deploy: false
  host: "redis.default.svc.cluster.local"
  port: 6379
  auth:
    existingSecret: redis-secrets
    existingSecretPasswordKey: redis-password

# Deploy ClickHouse with stable resources and probes
clickhouse:
  deploy: true
  host: langfuse-clickhouse

  auth:
    username: default
    existingSecret: langfuse-clickhouse
    existingSecretKey: admin-password

  resources:
    requests:
      memory: "1Gi"
      cpu: "100m"
    limits:
      memory: "4Gi"
      cpu: "1"

  replicaCount: 1

  zookeeper:
    enabled: false

  persistence:
    size: 2Gi

  # System table TTL configuration (3-day retention)
  # Prevents unbounded growth of ClickHouse system log tables
  # which caused OOM merge storms (metric_log hit 223 parts, 7+ GiB)
  #
  # IMPORTANT: opentelemetry_span_log uses <engine> (not <ttl>) because
  # the default config.xml already defines <engine> for that table.
  # ClickHouse 25.x crashes (error 36) when both <engine> and <ttl> coexist.
  # All other tables use standalone <ttl> since they have no <engine> in config.
  # asynchronous_insert_log already has 3-day TTL in default config.
  # processors_profile_log default is 30 days â€” overridden to 3 days here.
  extraOverrides: |
    <clickhouse>
      <query_log>
        <ttl>event_date + INTERVAL 3 DAY DELETE</ttl>
      </query_log>
      <trace_log>
        <ttl>event_date + INTERVAL 3 DAY DELETE</ttl>
      </trace_log>
      <text_log>
        <ttl>event_date + INTERVAL 3 DAY DELETE</ttl>
      </text_log>
      <metric_log>
        <ttl>event_date + INTERVAL 3 DAY DELETE</ttl>
      </metric_log>
      <asynchronous_metric_log>
        <ttl>event_date + INTERVAL 3 DAY DELETE</ttl>
      </asynchronous_metric_log>
      <part_log>
        <ttl>event_date + INTERVAL 3 DAY DELETE</ttl>
      </part_log>
      <opentelemetry_span_log>
        <engine>
            engine MergeTree
            partition by toYYYYMM(finish_date)
            order by (finish_date, finish_time_us, trace_id)
            TTL finish_date + toIntervalDay(3)
        </engine>
      </opentelemetry_span_log>
      <query_metric_log>
        <ttl>event_date + INTERVAL 3 DAY DELETE</ttl>
      </query_metric_log>
      <processors_profile_log>
        <ttl>event_date + INTERVAL 3 DAY DELETE</ttl>
      </processors_profile_log>
      <error_log>
        <ttl>event_date + INTERVAL 3 DAY DELETE</ttl>
      </error_log>
      <latency_log>
        <ttl>event_date + INTERVAL 3 DAY DELETE</ttl>
      </latency_log>
    </clickhouse>

  # CRITICAL: Startup probe allows ClickHouse time to load large datasets
  # Without this, liveness probe kills container during metadata loading
  startupProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 30  # 30 * 10s = 5 minutes max startup time

  livenessProbe:
    enabled: true
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    enabled: true
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

# S3/MinIO for blob storage
s3:
  deploy: true
  auth:
    existingSecret: langfuse-s3
    rootUserSecretKey: root-user
    rootPasswordSecretKey: root-password

service:
  type: ClusterIP
  port: 3000

replicaCount: 1
