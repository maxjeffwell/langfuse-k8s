# Langfuse Stable Configuration
# Secrets managed via Doppler + External Secrets Operator
# Updated: 2026-02-02 - Fixed probes for ClickHouse, web app, and S3 credentials

langfuse:
  salt:
    secretKeyRef:
      name: langfuse-salt
      key: salt

  encryptionKey:
    secretKeyRef:
      name: langfuse-encryption
      key: encryption-key

  nextauth:
    url: "https://langfuse.el-jefe.me"
    secret:
      secretKeyRef:
        name: langfuse-nextauth
        key: nextauth-secret

  features:
    telemetryEnabled: false
    signUpDisabled: false

  # Web deployment configuration
  web:
    livenessProbe:
      initialDelaySeconds: 120
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

    readinessProbe:
      initialDelaySeconds: 60
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

  # Worker deployment configuration
  worker:
    livenessProbe:
      initialDelaySeconds: 60
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

# Use Neon PostgreSQL (external)
postgresql:
  deploy: false
  host: "ep-flat-resonance-addiekdb.c-2.us-east-1.aws.neon.tech"
  port: 5432
  auth:
    username: "neondb_owner"
    database: "langfuse"
    existingSecret: langfuse-postgresql
    secretKeys:
      userPasswordKey: postgres-password
  args: "sslmode=require"

# Use existing Redis
redis:
  deploy: false
  host: "redis.default.svc.cluster.local"
  port: 6379
  auth:
    existingSecret: redis-secrets
    existingSecretPasswordKey: redis-password

# Deploy ClickHouse with stable resources and probes
clickhouse:
  deploy: true
  host: langfuse-clickhouse

  auth:
    username: default
    existingSecret: langfuse-clickhouse
    existingSecretKey: admin-password

  resources:
    requests:
      memory: "1Gi"
      cpu: "100m"
    limits:
      memory: "4Gi"
      cpu: "1"

  replicaCount: 1

  zookeeper:
    enabled: false

  persistence:
    size: 2Gi

  # CRITICAL: Startup probe allows ClickHouse time to load large datasets
  # Without this, liveness probe kills container during metadata loading
  startupProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 30  # 30 * 10s = 5 minutes max startup time

  livenessProbe:
    enabled: true
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    enabled: true
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

# S3/MinIO for blob storage
s3:
  deploy: true
  auth:
    existingSecret: langfuse-s3
    rootUserSecretKey: root-user
    rootPasswordSecretKey: root-password

service:
  type: ClusterIP
  port: 3000

replicaCount: 1
